<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionVIP Dashboard v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f8fafc', 900: '#0f172a' },
                        accent: { 400: '#fbbf24', 600: '#d97706' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shimmer': 'shimmer 2s infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }
        
        .card-3d:hover {
            transform: rotateY(5deg) rotateX(5deg);
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #8b5cf6, #06b6d4, #10b981, #f59e0b);
            border-radius: 12px;
            padding: 2px;
        }
        
        .gradient-border > div {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
        }
        
        .status-indicator {
            position: relative;
            overflow: hidden;
        }
        
        .status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .status-indicator:hover::before {
            left: 100%;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white transition-all duration-300">
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="fixed top-4 right-4 z-50 p-3 rounded-full glass-effect hover:scale-110 transition-transform duration-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-accent-400 mx-auto mb-4"></div>
            <p class="text-lg font-semibold animate-pulse">Loading Dashboard...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="auth" class="flex flex-col justify-center items-center min-h-screen p-4">
        <div class="glass-effect p-8 rounded-2xl shadow-2xl w-full max-w-md animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center animate-float">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">FusionVIP</h1>
                <h2 class="text-xl font-semibold mb-2">üîê Access Control</h2>
                <p class="text-gray-300">Enter credentials to continue</p>
            </div>
            <input type="password" id="password" placeholder="Enter password" 
                   class="w-full p-4 rounded-lg glass-effect mb-4 focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
            <button onclick="login()" 
                    class="w-full p-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300">
                Access Dashboard
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden max-w-7xl mx-auto p-4 space-y-6">
        <!-- Header with Advanced Controls -->
        <header class="sticky top-0 z-10 glass-effect rounded-2xl p-6 mb-6 animate-slide-up shimmer">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                        üî• FusionVIP Dashboard v2.0
                    </h1>
                    <p class="text-gray-300 mt-1">Advanced VIP Management System</p>
                </div>
                <div class="flex gap-3">
                    <div class="relative">
                        <input type="text" id="search" placeholder="üîç Smart Search..." 
                               class="pl-10 pr-4 py-3 rounded-lg glass-effect w-64 focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
                        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <button id="autoCleanup" onclick="toggleAutoCleanup()" 
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all duration-300">
                        <span id="cleanupStatus">üîÑ Auto-Clean: OFF</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Enhanced Stats Cards with 3D Effects -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            <!-- Total VIPs Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.1s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Total VIPs</h3>
                            <div class="text-3xl font-bold mt-2" id="totalVips">0</div>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center animate-pulse-glow">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active VIPs Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.2s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Active VIPs</h3>
                            <div class="text-3xl font-bold text-green-400 mt-2" id="activeVips">0</div>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expired VIPs Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.3s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Expired VIPs</h3>
                            <div class="text-3xl font-bold text-red-400 mt-2" id="expiredVips">0</div>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-red-500 to-pink-500 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expiring Soon Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.4s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Expiring Soon</h3>
                            <div class="text-3xl font-bold text-yellow-400 mt-2" id="expiringSoon">0</div>
                            <p class="text-sm text-gray-400 mt-1">Next 7 days</p>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-500 to-orange-500 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Add Form -->
        <div class="glass-effect rounded-2xl p-6 animate-slide-up">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </span>
                Add New VIP User
            </h2>
            <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">HWID</label>
                    <input type="text" placeholder="Enter HWID" id="hwid" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" placeholder="Enter username" id="username" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Expiry Date</label>
                    <input type="date" id="expiry" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Role</label>
                    <select id="role" class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
                        <option value="VIP">VIP</option>
                        <option value="Premium">Premium</option>
                        <option value="Admin">Admin</option>
                        <option value="Moderator">Moderator</option>
                    </select>
                </div>
                <div class="md:col-span-2 xl:col-span-4">
                    <button type="submit" 
                            class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300">
                        ‚ú® Add VIP User
                    </button>
                </div>
            </form>
        </div>

        <!-- Enhanced Data Table with Modern Design -->
        <div class="glass-effect rounded-2xl p-6 animate-slide-up">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                <h2 class="text-2xl font-bold">VIP Users Management</h2>
                <div class="flex gap-3">
                    <button onclick="exportData()" 
                            class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all duration-300">
                        üìä Export
                    </button>
                    <button onclick="bulkActions()" 
                            class="px-4 py-2 bg-gradient-to-r from-orange-600 to-red-600 rounded-lg font-semibold hover:from-orange-700 hover:to-red-700 transition-all duration-300">
                        ‚ö° Bulk Actions
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs uppercase bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                        <tr>
                            <th class="px-6 py-4">
                                <input type="checkbox" id="selectAll" class="rounded">
                            </th>
                            <th class="px-6 py-4 font-semibold">HWID</th>
                            <th class="px-6 py-4 font-semibold">Username</th>
                            <th class="px-6 py-4 font-semibold">Expiry Date</th>
                            <th class="px-6 py-4 font-semibold">Role</th>
                            <th class="px-6 py-4 font-semibold">Status</th>
                            <th class="px-6 py-4 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vipTable" class="divide-y divide-white/10">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="glass-effect rounded-2xl p-6 animate-slide-up">
            <h2 class="text-2xl font-bold mb-6">üìà Analytics Overview</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-lg p-4">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
                <div class="glass-effect rounded-lg p-4">
                    <canvas id="trendsChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Keep original authentication script -->
    <script>
        const PASSWORD = "fusionvip123"; // Your hardcoded password

        function checkPassword() {
            const input = document.getElementById("passwordInput").value;
            if (input === PASSWORD) {
                sessionStorage.setItem("loggedIn", "true");
                document.getElementById("auth").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                window.onload(); // Load dashboard data
            } else {
                alert("‚ùå Incorrect password");
            }
        }

        if (sessionStorage.getItem("loggedIn")) {
            document.getElementById("auth").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
        }
    </script>

    <!-- Main Enhanced JavaScript with Netlify Functions Integration -->
    <script>
        // Enhanced JavaScript with Modern Features + Netlify Functions Integration
        const api = path => `/.netlify/functions/${path}`;
        let vipData = [];
        let hwidList = [];
        let autoCleanupEnabled = false;
        let cleanupInterval;

        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const isDark = localStorage.getItem('darkMode') === 'true';
            
            if (isDark) {
                document.documentElement.classList.add('dark');
            }
            
            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
            });
        }

        // Enhanced login with animations
        function login() {
            const password = document.getElementById('password').value;
            
            if (password === PASSWORD) {
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    document.getElementById('auth').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    sessionStorage.setItem("loggedIn", "true");
                    initDashboard();
                }, 1500);
            } else {
                showNotification('‚ùå Incorrect password!', 'error');
                document.getElementById('password').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('password').classList.remove('shake');
                }, 500);
            }
        }

        // Convert original HWID format to new format
        function convertHWIDData(originalData) {
            return originalData.map(line => {
                const parts = line.split(' ');
                if (parts.length >= 3) {
                    const [hwid, username, dateStr, ...roleParts] = parts;
                    const role = roleParts.join(' ') || 'VIP';
                    
                    // Convert DD-MM-YYYY to YYYY-MM-DD for consistency
                    const [dd, mm, yyyy] = dateStr.split('-');
                    const expiry = `${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`;
                    
                    return { 
                        hwid, 
                        username, 
                        expiry, 
                        role, 
                        createdAt: new Date().toISOString() 
                    };
                }
                return null;
            }).filter(Boolean);
        }

        // Enhanced data fetching with your existing API
        async function fetchHWIDs() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                const res = await fetch(api('read-hwid'));
                const data = await res.json();
                
                hwidList = data.lines || [];
                vipData = convertHWIDData(hwidList);
                
                updateStats();
                renderTable();
                updateCharts();
                
                showNotification(`‚úÖ Loaded ${vipData.length} VIP users`, 'success');
            } catch (error) {
                showNotification("‚ùå Failed to load VIP data", 'error');
                console.error('Fetch error:', error);
                
                // Fallback to localStorage if API fails
                const cachedData = localStorage.getItem('vipData');
                if (cachedData) {
                    vipData = JSON.parse(cachedData);
                    updateStats();
                    renderTable();
                    updateCharts();
                    showNotification("üìã Loaded cached data", 'info');
                }
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Enhanced add user function with API integration
        async function addUser(hwid, username, expiry, role) {
            try {
                showLoading();
                
                // Convert YYYY-MM-DD back to DD-MM-YYYY for API
                const [yyyy, mm, dd] = expiry.split('-');
                const apiDate = `${dd}-${mm}-${yyyy}`;
                
                const newEntry = `${hwid} ${username} ${apiDate} ${role}`;
                
                const response = await fetch(api('write-hwid'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'add',
                        data: newEntry 
                    })
                });
                
                if (response.ok) {
                    // Refresh data from server
                    await fetchHWIDs();
                    showNotification('‚úÖ VIP user added successfully!', 'success');
                    return true;
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                console.error('Add user error:', error);
                showNotification('‚ùå Failed to add user', 'error');
                return false;
            } finally {
                hideLoading();
            }
        }

        // Enhanced delete user function
        async function deleteUser(index) {
            if (!confirm('Are you sure you want to delete this VIP user?')) return;
            
            try {
                showLoading();
                const user = vipData[index];
                
                const response = await fetch(api('write-hwid'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'delete',
                        hwid: user.hwid 
                    })
                });
                
                if (response.ok) {
                    await fetchHWIDs();
                    showNotification(`üóëÔ∏è Deleted user: ${user.username}`, 'info');
                } else {
                    throw new Error('Delete request failed');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('‚ùå Failed to delete user', 'error');
            } finally {
                hideLoading();
            }
        }

        // Auto cleanup function with API integration
        async function autoDeleteExpired() {
            const today = new Date().toISOString().split('T')[0];
            const expiredUsers = vipData.filter(user => user.expiry < today);
            
            if (expiredUsers.length === 0) return;
            
            try {
                for (const user of expiredUsers) {
                    await fetch(api('write-hwid'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'delete',
                            hwid: user.hwid 
                        })
                    });
                }
                
                await fetchHWIDs();
                showNotification(`üóëÔ∏è Auto-deleted ${expiredUsers.length} expired VIP(s)`, 'info');
            } catch (error) {
                console.error('Auto cleanup error:', error);
                showNotification('‚ùå Auto cleanup failed', 'error');
            }
        }

        // Initialize dashboard with enhanced features
        function initDashboard() {
            fetchHWIDs(); // Load data from API
            initCharts();
            setupEventListeners();
            setupAutoCleanup();
            initDarkMode();
            resetInactivityTimer();
        }

        // Session management (from your original code)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                sessionStorage.removeItem('loggedIn');
                showNotification("Session expired. Please login again.", 'warning');
                location.reload();
            }, 30 * 60 * 1000); // 30 minutes
        }

        ['mousemove', 'keypress', 'click'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer);
        });

        // Enhanced statistics with trend analysis
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const totalVips = vipData.length;
            const activeVips = vipData.filter(user => user.expiry >= today).length;
            const expiredVips = vipData.filter(user => user.expiry < today).length;
            const expiringSoon = vipData.filter(user => user.expiry >= today && user.expiry <= nextWeek).length;
            
            // Cache data locally as backup
            localStorage.setItem('vipData', JSON.stringify(vipData));
            
            // Animate number changes
            animateNumber('totalVips', totalVips);
            animateNumber('activeVips', activeVips);
            animateNumber('expiredVips', expiredVips);
            animateNumber('expiringSoon', expiringSoon);
        }

        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            const step = (targetValue - currentValue) / 20;
            let current = currentValue;
            
            const timer = setInterval(() => {
                current += step;
                if ((step > 0 && current >= targetValue) || (step < 0 && current <= targetValue)) {
                    element.textContent = targetValue;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 50);
        }

        // Enhanced table rendering with status indicators
        function renderTable() {
            const tableBody = document.getElementById('vipTable');
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            const filteredData = vipData.filter(user => 
                user.hwid.toLowerCase().includes(searchTerm) ||
                user.username.toLowerCase().includes(searchTerm) ||
                user.role.toLowerCase().includes(searchTerm)
            );
            
            tableBody.innerHTML = filteredData.map((user, index) => {
                const originalIndex = vipData.findIndex(u => u.hwid === user.hwid);
                const isExpired = new Date(user.expiry) < new Date();
                const isExpiringSoon = !isExpired && new Date(user.expiry) <= new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
                
                let statusClass = 'bg-green-500';
                let statusText = 'Active';
                let statusIcon = '‚úÖ';
                
                if (isExpired) {
                    statusClass = 'bg-red-500';
                    statusText = 'Expired';
                    statusIcon = '‚ùå';
                } else if (isExpiringSoon) {
                    statusClass = 'bg-yellow-500';
                    statusText = 'Expiring Soon';
                    statusIcon = '‚ö†Ô∏è';
                }
                
                return `
                    <tr class="hover:bg-white/5 transition-all duration-300 border-b border-white/10">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="row-select rounded" data-index="${originalIndex}">
                        </td>
                        <td class="px-6 py-4 font-mono text-sm">${user.hwid}</td>
                        <td class="px-6 py-4 font-semibold">${user.username}</td>
                        <td class="px-6 py-4">${formatDate(user.expiry)}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-300">
                                ${user.role}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="status-indicator inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold ${statusClass}/20 text-white">
                                ${statusIcon} ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="editUser(${originalIndex})" 
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors duration-300">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteUser(${originalIndex})" 
                                        class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors duration-300">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Enhanced form handling with API integration
        function setupEventListeners() {
            document.getElementById('addForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const hwid = document.getElementById('hwid').value.trim();
                const username = document.getElementById('username').value.trim();
                const expiry = document.getElementById('expiry').value;
                const role = document.getElementById('role').value;
                
                // Enhanced validation
                if (!hwid || !username || !expiry) {
                    showNotification('‚ùå Please fill all required fields!', 'error');
                    return;
                }
                
                if (vipData.some(user => user.hwid === hwid)) {
                    showNotification('‚ùå HWID already exists!', 'error');
                    return;
                }
                
                const success = await addUser(hwid, username, expiry, role);
                if (success) {
                    this.reset();
                }
            });
            
            document.getElementById('search').addEventListener('input', renderTable);
            document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
        }

        // Charts initialization with Chart.js
        function initCharts() {
            // Status distribution chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const today = new Date().toISOString().split('T')[0];
            
            const active = vipData.filter(user => user.expiry >= today).length;
            const expired = vipData.filter(user => user.expiry < today).length;
            
            window.statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Expired'],
                    datasets: [{
                        data: [active, expired],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'VIP Status Distribution', color: '#fff' },
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
            
            // Trends chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            window.trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'New VIPs',
                        data: [12, 19, 15, 25, 22, 18],
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'VIP Registration Trends', color: '#fff' },
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function updateCharts() {
            if (window.statusChart && window.trendsChart) {
                const today = new Date().toISOString().split('T')[0];
                const active = vipData.filter(user => user.expiry >= today).length;
                const expired = vipData.filter(user => user.expiry < today).length;
                
                window.statusChart.data.datasets[0].data = [active, expired];
                window.statusChart.update();
            }
        }

        // Auto cleanup setup
        function setupAutoCleanup() {
            if (autoCleanupEnabled) {
                cleanupInterval = setInterval(autoDeleteExpired, 60000);
            }
        }

        function toggleAutoCleanup() {
            autoCleanupEnabled = !autoCleanupEnabled;
            const statusElement = document.getElementById('cleanupStatus');
            
            if (autoCleanupEnabled) {
                statusElement.textContent = 'üîÑ Auto-Clean: ON';
                statusElement.parentElement.classList.remove('from-green-600', 'to-emerald-600');
                statusElement.parentElement.classList.add('from-red-600', 'to-pink-600');
                setupAutoCleanup();
                showNotification('‚úÖ Auto cleanup enabled!', 'success');
            } else {
                statusElement.textContent = 'üîÑ Auto-Clean: OFF';
                statusElement.parentElement.classList.remove('from-red-600', 'to-pink-600');
                statusElement.parentElement.classList.add('from-green-600', 'to-emerald-600');
                clearInterval(cleanupInterval);
                showNotification('‚è∏Ô∏è Auto cleanup disabled!', 'info');
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold animate-fade-in ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function editUser(index) {
            showNotification('Edit functionality - Coming soon!', 'info');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const rowSelects = document.querySelectorAll('.row-select');
            
            rowSelects.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "HWID,Username,Expiry Date,Role,Status\n" +
                vipData.map(user => {
                    const isExpired = new Date(user.expiry) < new Date();
                    const status = isExpired ? 'Expired' : 'Active';
                    return `${user.hwid},${user.username},${user.expiry},${user.role},${status}`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `vip_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üìä Data exported successfully!', 'success');
        }

        function bulkActions() {
            const selectedRows = document.querySelectorAll('.row-select:checked');
            if (selectedRows.length === 0) {
                showNotification('‚ö†Ô∏è Please select users first!', 'warning');
                return;
            }
            
            showNotification(`Selected ${selectedRows.length} users. Bulk actions coming soon!`, 'info');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('expiry').min = new Date().toISOString().split('T')[0];
            
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });

            // Auto-login if session exists
            if (sessionStorage.getItem("loggedIn")) {
                document.getElementById('auth').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                initDashboard();
            }
        });
    </script>
</body>
</html>
