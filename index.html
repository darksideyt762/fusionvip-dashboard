<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FusionVIP Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .divider {
      height: 4px;
      background: linear-gradient(to right, #8B5CF6, #1F2937);
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; transform: translateY(10px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
    }
    tr {
      transition: all 0.2s ease;
    }
    tr:hover {
      background-color: rgba(255, 255, 255, 0.15) !important;
    }
    .editing {
      outline: 2px solid #F59E0B;
    }
    [contenteditable="true"] {
      background-color: rgba(255, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-primary {
      background: linear-gradient(45deg, #8B5CF6, #EC4899);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(45deg, #7C3AED, #DB2777);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    .btn-secondary {
      background: linear-gradient(45deg, #10B981, #06B6D4);
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      background: linear-gradient(45deg, #059669, #0891B2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-danger {
      background: linear-gradient(45deg, #EF4444, #DC2626);
      transition: all 0.3s ease;
    }
    .btn-danger:hover {
      background: linear-gradient(45deg, #DC2626, #B91C1C);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .table-container {
      max-height: 500px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(139, 92, 246, 0.5) rgba(0, 0, 0, 0.1);
    }
    .table-container::-webkit-scrollbar {
      width: 6px;
    }
    .table-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }
    .table-container::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.5);
      border-radius: 3px;
    }
    .table-container::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.7);
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    .status-active {
      background-color: rgba(34, 197, 94, 0.2);
      color: #22C55E;
    }
    .status-expired {
      background-color: rgba(239, 68, 68, 0.2);
      color: #EF4444;
    }
    .status-warning {
      background-color: rgba(245, 158, 11, 0.2);
      color: #F59E0B;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-violet-900 via-purple-900 to-black min-h-screen p-4 text-white font-sans">

  <!-- Loading Overlay -->
  <div id="loading" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden z-50">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-yellow-400 mb-4"></div>
      <p class="text-white">Processing...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- 🔐 Login Screen -->
  <div id="auth" class="flex flex-col justify-center items-center min-h-screen">
    <div class="glass-effect p-8 rounded-2xl shadow-2xl w-full max-w-md fade-in">
      <div class="text-center mb-6">
        <div class="w-20 h-20 bg-gradient-to-r from-violet-600 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-lock text-3xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold">FusionVIP Dashboard</h2>
        <p class="text-gray-300 mt-2">Enter your password to continue</p>
      </div>
      <div class="space-y-4">
        <div class="relative">
          <i class="fas fa-key absolute left-3 top-3 text-gray-400"></i>
          <input type="password" id="passwordInput" placeholder="Password" 
                 class="w-full pl-10 pr-4 py-3 rounded-lg bg-white/10 placeholder-gray-300 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500" 
                 autocomplete="current-password" />
        </div>
        <button onclick="checkPassword()" 
                class="btn-primary w-full px-4 py-3 font-bold rounded-lg transition">
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
      </div>
    </div>
  </div>

  <!-- 💻 Dashboard -->
  <div id="dashboard" class="hidden max-w-6xl mx-auto space-y-6 fade-in">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-violet-400 to-pink-400 bg-clip-text text-transparent">
          <i class="fas fa-crown mr-3"></i>FusionVIP Dashboard
        </h1>
        <p class="text-gray-300 mt-1">Manage VIP members and their access</p>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="cleanExpiredHWIDs()" 
                class="btn-danger px-4 py-2 text-white text-sm rounded-lg flex items-center">
          <i class="fas fa-trash mr-2"></i>Clean Expired
        </button>
        <button onclick="exportToCSV()" 
                class="btn-secondary px-4 py-2 text-white text-sm rounded-lg flex items-center">
          <i class="fas fa-file-export mr-2"></i>Export CSV
        </button>
        <button onclick="logout()" 
                class="px-4 py-2 bg-gray-700 text-white text-sm rounded-lg hover:bg-gray-600 transition flex items-center">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
    </div>

    <div class="divider rounded-full"></div>

    <!-- VIP Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
      <div class="glass-effect p-5 rounded-2xl shadow-md card-hover">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">Total VIPs</h3>
            <div class="text-3xl font-bold mt-2" id="totalVips">0</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-violet-600/20 flex items-center justify-center">
            <i class="fas fa-users text-violet-400 text-xl"></i>
          </div>
        </div>
      </div>
      <div class="glass-effect p-5 rounded-2xl shadow-md card-hover">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">Active VIPs</h3>
            <div class="text-3xl font-bold text-green-400 mt-2" id="activeVips">0</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-green-600/20 flex items-center justify-center">
            <i class="fas fa-check-circle text-green-400 text-xl"></i>
          </div>
        </div>
      </div>
      <div class="glass-effect p-5 rounded-2xl shadow-md card-hover">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">Expired VIPs</h3>
            <div class="text-3xl font-bold text-red-400 mt-2" id="expiredVips">0</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-red-600/20 flex items-center justify-center">
            <i class="fas fa-times-circle text-red-400 text-xl"></i>
          </div>
        </div>
      </div>
      <div class="glass-effect p-5 rounded-2xl shadow-md card-hover">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-300">Expiring Soon</h3>
            <div class="text-3xl font-bold text-yellow-400 mt-2" id="expiringSoon">0</div>
          </div>
          <div class="w-12 h-12 rounded-full bg-yellow-600/20 flex items-center justify-center">
            <i class="fas fa-clock text-yellow-400 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="glass-effect p-4 rounded-xl flex flex-col md:flex-row gap-4 items-center">
      <div class="relative flex-1">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        <input type="text" id="search" placeholder="Search by username or HWID..." 
               class="w-full pl-10 pr-4 py-2 rounded-lg bg-white/10 placeholder-gray-300 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500"/>
      </div>
      <div class="flex gap-2">
        <select id="statusFilter" class="px-3 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500">
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="expired">Expired</option>
          <option value="expiring">Expiring Soon</option>
        </select>
        <button onclick="clearFilters()" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Add Form -->
    <div class="glass-effect p-5 rounded-2xl shadow-md">
      <h2 class="text-xl font-bold mb-4 flex items-center">
        <i class="fas fa-plus-circle mr-2 text-violet-400"></i>Add New VIP
      </h2>
      <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm mb-2 text-gray-300">HWID</label>
          <div class="relative">
            <i class="fas fa-id-card absolute left-3 top-3 text-gray-400"></i>
            <input type="text" placeholder="Enter HWID" id="hwid" 
                   class="w-full pl-10 pr-4 py-2 rounded-lg bg-white/10 placeholder-gray-300 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500" required />
          </div>
        </div>
        <div>
          <label class="block text-sm mb-2 text-gray-300">Username</label>
          <div class="relative">
            <i class="fas fa-user absolute left-3 top-3 text-gray-400"></i>
            <input type="text" placeholder="Enter username" id="username" 
                   class="w-full pl-10 pr-4 py-2 rounded-lg bg-white/10 placeholder-gray-300 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500" required />
          </div>
        </div>
        <div>
          <label class="block text-sm mb-2 text-gray-300">Expiry Date</label>
          <div class="relative">
            <i class="fas fa-calendar-day absolute left-3 top-3 text-gray-400"></i>
            <input type="date" id="expiry" 
                   class="w-full pl-10 pr-4 py-2 rounded-lg bg-white/10 placeholder-gray-300 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500" required />
          </div>
        </div>
        <div>
          <label class="block text-sm mb-2 text-gray-300">Role</label>
          <div class="relative">
            <i class="fas fa-user-tag absolute left-3 top-3 text-gray-400"></i>
            <select id="role" class="w-full pl-10 pr-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-violet-500" required>
              <option value="">Select Role</option>
              <option value="VIP">VIP</option>
              <option value="PREMIUM">PREMIUM</option>
              <option value="ADMIN">ADMIN</option>
              <option value="MOD">MOD</option>
            </select>
          </div>
        </div>
        <button type="submit" class="btn-primary md:col-span-4 px-4 py-3 font-bold rounded-lg transition flex items-center justify-center">
          <i class="fas fa-plus mr-2"></i>Add HWID
        </button>
      </form>
    </div>

    <!-- HWID Table -->
    <div class="glass-effect rounded-2xl overflow-hidden">
      <div class="p-4 border-b border-white/10">
        <h2 class="text-xl font-bold flex items-center">
          <i class="fas fa-list mr-2 text-violet-400"></i>VIP Members
        </h2>
      </div>
      <div class="table-container">
        <table class="w-full text-sm text-left">
          <thead class="sticky top-0 z-10">
            <tr class="text-white uppercase text-xs bg-white/10">
              <th class="p-4">HWID</th>
              <th class="p-4">Username</th>
              <th class="p-4">Expiry</th>
              <th class="p-4">Role</th>
              <th class="p-4">Status</th>
              <th class="p-4 text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="hwidTable" class=""></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 🔒 Auth Logic -->
  <script>
  const PASSWORD = "fusionvip123"; // Your hardcoded password

  function checkPassword() {
    const input = document.getElementById("passwordInput").value;
    if (input === PASSWORD) {
      sessionStorage.setItem("loggedIn", "true");
      document.getElementById("auth").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      window.onload(); // Load dashboard data
    } else {
      showToast("❌ Incorrect password", true);
    }
  }

  function logout() {
    sessionStorage.removeItem("loggedIn");
    location.reload();
  }

  if (sessionStorage.getItem("loggedIn")) {
    document.getElementById("auth").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
  }
</script>

  <!-- Main App Logic -->
  <script>
    const api = path => `/.netlify/functions/${path}`;
    const tableBody = document.getElementById('hwidTable');
    const form = document.getElementById('addForm');
    const searchInput = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    let hwidList = [];
    let currentDisplayedList = [];
    let inactivityTimer;

    // Initialize
    window.onload = async () => {
      if (sessionStorage.getItem("loggedIn")) {
        await fetchHWIDs();
        checkExpiringSoon();
        resetInactivityTimer();
      }
    };

    // Session management
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        sessionStorage.removeItem('loggedIn');
        showToast("Session expired. Please login again.", true);
        location.reload();
      }, 30 * 60 * 1000); // 30 minutes
    }

    ['mousemove', 'keypress', 'click'].forEach(event => {
      document.addEventListener(event, resetInactivityTimer);
    });

    // Data functions
    async function fetchHWIDs() {
      try {
        document.getElementById('loading').classList.remove('hidden');
        const res = await fetch(api('read-hwid'));
        const data = await res.json();
        hwidList = data.lines || [];
        currentDisplayedList = [...hwidList];
        renderTable(hwidList);
        updateVIPStats();
      } catch (error) {
        showToast("Failed to load HWIDs", true);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    function updateVIPStats() {
      const total = hwidList.length;
      let active = 0;
      let expired = 0;
      let expiringSoon = 0;

      hwidList.forEach(line => {
        const parts = line.split(' ');
        if (parts.length >= 3) {
          const dateStr = parts[2];
          const [dd, mm, yyyy] = dateStr.split('-');
          const expiryDate = new Date(`${yyyy}-${mm}-${dd}`);
          const today = new Date();
          
          // Calculate days difference
          const diffTime = expiryDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays < 0) {
            expired++;
          } else if (diffDays <= 7) {
            expiringSoon++;
            active++;
          } else {
            active++;
          }
        }
      });

      document.getElementById('totalVips').textContent = total;
      document.getElementById('activeVips').textContent = active;
      document.getElementById('expiredVips').textContent = expired;
      document.getElementById('expiringSoon').textContent = expiringSoon;
    }

    function getStatus(dateStr) {
      if (!dateStr) return { status: 'unknown', text: 'Unknown', days: 0 };
      
      const [dd, mm, yyyy] = dateStr.split('-');
      const expiryDate = new Date(`${yyyy}-${mm}-${dd}`);
      const today = new Date();
      
      // Calculate days difference
      const diffTime = expiryDate - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays < 0) {
        return { status: 'expired', text: 'Expired', days: diffDays };
      } else if (diffDays <= 7) {
        return { status: 'expiring', text: `Expiring in ${diffDays} day${diffDays !== 1 ? 's' : ''}`, days: diffDays };
      } else {
        return { status: 'active', text: 'Active', days: diffDays };
      }
    }

    function renderTable(list) {
      tableBody.innerHTML = '';
      currentDisplayedList = list;
      
      if (list.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="p-8 text-center text-gray-400">
              <i class="fas fa-inbox text-4xl mb-2"></i>
              <p>No VIP members found</p>
            </td>
          </tr>`;
        return;
      }
      
      list.forEach((line) => {
        const [hwid, user, date, role] = line.split(' ');
        const status = getStatus(date);
        
        const tr = document.createElement('tr');
        tr.className = "border-b border-white/10 hover:bg-white/5 transition-colors";
        tr.innerHTML = `
          <td class="p-4 font-mono text-sm" data-key="hwid">${hwid}</td>
          <td class="p-4 font-medium" data-key="user">${user}</td>
          <td class="p-4" data-key="date">${date}</td>
          <td class="p-4" data-key="role">
            <span class="px-2 py-1 rounded-full bg-violet-600/20 text-violet-300 text-xs">${role || 'N/A'}</span>
          </td>
          <td class="p-4">
            <span class="status-badge status-${status.status}">${status.text}</span>
          </td>
          <td class="p-4 space-x-2 text-center">
            <button onclick="enableEdit(this, '${hwid}')" class="px-3 py-1 bg-yellow-500 text-white text-xs rounded-lg hover:bg-yellow-600 transition">
              <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button onclick="deleteLine('${hwid}')" class="px-3 py-1 bg-red-600 text-white text-xs rounded-lg hover:bg-red-700 transition">
              <i class="fas fa-trash mr-1"></i>Delete
            </button>
          </td>`;
        tableBody.appendChild(tr);
      });
    }

    // Form handling
    form.onsubmit = async (e) => {
      e.preventDefault();
      const hwid = document.getElementById('hwid').value.trim();
      const username = document.getElementById('username').value.trim();
      const rawDate = document.getElementById('expiry').value;
      const role = document.getElementById('role').value.trim();

      if (!hwid || !username || !rawDate || !role) {
        showToast("Please fill all fields", true);
        return;
      }

      if (!isValidHWID(hwid)) {
        showToast("Invalid HWID format", true);
        return;
      }

      const expiry = formatDateForStorage(rawDate);
      const line = `${hwid} ${username} ${expiry} ${role}`;

      try {
        document.getElementById('loading').classList.remove('hidden');
        const res = await fetch(api('write-hwid'), {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ line })
        });
        const result = await res.json();
        
        if (result.success) {
          await fetchHWIDs();
          form.reset();
          showToast("VIP member added successfully");
        } else {
          showToast("Failed to add VIP member", true);
        }
      } catch (error) {
        showToast("Error adding VIP member", true);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    };

    // Edit functions
    function enableEdit(button, hwid) {
      const row = button.closest('tr');
      row.classList.add('editing');
      
      const cells = row.querySelectorAll('td[data-key]');
      cells.forEach(cell => {
        cell.setAttribute('contenteditable', 'true');
        cell.classList.add('bg-white/10');
      });

      button.innerHTML = '<i class="fas fa-save mr-1"></i>Save';
      button.classList.replace('bg-yellow-500', 'bg-green-600');
      button.onclick = () => saveEdit(button, hwid);
      
      // Add cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times mr-1"></i>Cancel';
      cancelBtn.className = 'px-3 py-1 bg-gray-600 text-white text-xs rounded-lg ml-2 hover:bg-gray-700 transition';
      cancelBtn.onclick = () => fetchHWIDs();
      button.parentNode.insertBefore(cancelBtn, button.nextSibling);
    }

    async function saveEdit(button, originalHwid) {
      const row = button.closest('tr');
      const cells = row.querySelectorAll('td[data-key]');

      const hwid = cells[0].textContent.trim();
      const user = cells[1].textContent.trim();
      let date = cells[2].textContent.trim();
      const role = cells[3].textContent.trim();

      if (!hwid || !user || !date || !role) {
        showToast("All fields are required", true);
        return;
      }

      if (date.includes("-") && date.split("-")[0].length === 4) {
        date = formatDateForStorage(date);
      }

      const line = `${hwid} ${user} ${date} ${role}`;

      try {
        document.getElementById('loading').classList.remove('hidden');
        const res = await fetch(api('edit-hwid'), {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ originalHwid, newLine: line })
        });
        
        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Failed to save changes');

        await fetchHWIDs();
        showToast("Changes saved successfully");
      } catch (error) {
        showToast(error.message, true);
        console.error('Edit error:', error);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Delete function
    async function deleteLine(hwid) {
      if (!confirm("Are you sure you want to delete this VIP member?")) return;
      
      try {
        document.getElementById('loading').classList.remove('hidden');
        const res = await fetch(api('delete-hwid'), {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ hwid })
        });
        
        const result = await res.json();
        if (!res.ok) throw new Error(result.error || 'Failed to delete VIP member');

        await fetchHWIDs();
        showToast("VIP member deleted");
      } catch (error) {
        showToast(error.message, true);
        console.error('Delete error:', error);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Clean expired HWIDs
    async function cleanExpiredHWIDs() {
      if (!confirm("This will permanently remove all expired VIP members. Continue?")) return;
      
      try {
        document.getElementById('loading').classList.remove('hidden');
        
        // Get current data
        const res = await fetch(api('read-hwid'));
        const data = await res.json();
        const lines = data.lines || [];
        const sha = data.sha;
        
        // Filter out expired entries
        const now = new Date();
        const validLines = lines.filter(line => {
          const parts = line.split(' ');
          if (parts.length < 3) return true; // Keep malformed lines
          
          const dateStr = parts[2];
          const [dd, mm, yyyy] = dateStr.split('-');
          const expiryDate = new Date(`${yyyy}-${mm}-${dd}`);
          
          return expiryDate >= now;
        });
        
        if (validLines.length === lines.length) {
          showToast("No expired VIP members found");
          document.getElementById('loading').classList.add('hidden');
          return;
        }
        
        // Update the file
        const updatedContent = validLines.join('\n');
        const encoded = Buffer.from(updatedContent).toString('base64');
        
        const updateRes = await fetch(`https://api.github.com/repos/Immortal-hacker/FusionVIP-Other/contents/hwid.txt`, {
          method: "PUT",
          headers: {
            Authorization: `token ${process.env.GITHUB_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Removed ${lines.length - validLines.length} expired VIP members`,
            content: encoded,
            sha: sha,
            branch: 'main'
          })
        });
        
        if (!updateRes.ok) throw new Error('Failed to remove expired VIP members');
        
        const removedCount = lines.length - validLines.length;
        await fetchHWIDs();
        showToast(`Removed ${removedCount} expired VIP members`);
      } catch (error) {
        showToast(error.message, true);
        console.error('Clean error:', error);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    // Check for expiring soon
    async function checkExpiringSoon() {
      try {
        const res = await fetch(api('check-expiry'));
        const data = await res.json();
        
        if (data.expiringSoon && data.expiringSoon.length > 0) {
          showToast(`${data.expiringSoon.length} VIP members expiring soon`, false);
        }
      } catch (error) {
        console.error('Error checking expiring VIPs:', error);
      }
    }

    // Search and filter functions
    searchInput.addEventListener('input', applyFilters);
    statusFilter.addEventListener('change', applyFilters);

    function applyFilters() {
      const keyword = searchInput.value.toLowerCase();
      const status = statusFilter.value;
      
      const filtered = hwidList.filter(line => {
        // Search filter
        if (keyword && !line.toLowerCase().includes(keyword)) {
          return false;
        }
        
        // Status filter
        if (status !== 'all') {
          const parts = line.split(' ');
          if (parts.length < 3) return status === 'expired'; // Consider malformed as expired
          
          const dateStr = parts[2];
          const lineStatus = getStatus(dateStr).status;
          
          if (status === 'active' && lineStatus !== 'active') return false;
          if (status === 'expired' && lineStatus !== 'expired') return false;
          if (status === 'expiring' && lineStatus !== 'expiring') return false;
        }
        
        return true;
      });
      
      renderTable(filtered);
    }

    function clearFilters() {
      searchInput.value = '';
      statusFilter.value = 'all';
      applyFilters();
    }
   
    // Helper functions
    function isValidHWID(hwid) {
      return hwid.length > 10 && /^[a-zA-Z0-9-]+$/.test(hwid);
    }

    function formatDateForStorage(dateStr) {
      const [yyyy, mm, dd] = dateStr.split('-');
      return `${dd}-${mm}-${yyyy}`;
    }

    function exportToCSV() {
      if (hwidList.length === 0) {
        showToast("No data to export", true);
        return;
      }

      const headers = ['HWID', 'Username', 'Expiry', 'Role', 'Status'];
      const csvContent = [
        headers.join(','),
        ...hwidList.map(line => {
          const parts = line.split(' ');
          const status = getStatus(parts[2]);
          return `${line.replace(/ /g, ',')},${status.text}`;
        })
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `fusionvip-hwids-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      showToast("CSV export started");
    }

    function showToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.className = `p-4 rounded-lg shadow-lg flex items-center ${
        isError ? 'bg-red-600' : 'bg-green-600'
      } text-white animate-fadeInOut`;
      
      toast.innerHTML = `
        <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>
        <span>${message}</span>
      `;
      
      document.getElementById('toast-container').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
