<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionVIP Dashboard v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f8fafc', 900: '#0f172a' },
                        accent: { 400: '#fbbf24', 600: '#d97706' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.8s ease-out',
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'float': 'float 6s ease-in-out infinite'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-3d {
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }
        
        .card-3d:hover {
            transform: rotateY(5deg) rotateX(5deg);
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #8b5cf6, #06b6d4, #10b981, #f59e0b);
            border-radius: 12px;
            padding: 2px;
        }
        
        .gradient-border > div {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
        }
        
        .status-indicator {
            position: relative;
            overflow: hidden;
        }
        
        .status-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .status-indicator:hover::before {
            left: 100%;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        tr.editing {
            background-color: rgba(255, 255, 0, 0.1) !important;
        }
        
        [contenteditable="true"] {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            outline: 2px solid #fbbf24;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white transition-all duration-300">
    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="fixed top-4 right-4 z-50 p-3 rounded-full glass-effect hover:scale-110 transition-transform duration-300">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>

    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-accent-400 mx-auto mb-4"></div>
            <p class="text-lg font-semibold animate-pulse">Processing...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="auth" class="flex flex-col justify-center items-center min-h-screen p-4">
        <div class="glass-effect p-8 rounded-2xl shadow-2xl w-full max-w-md animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center animate-float">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">FusionVIP</h1>
                <h2 class="text-xl font-semibold mb-2">üîê Access Control</h2>
                <p class="text-gray-300">Enter credentials to continue</p>
            </div>
            <input type="password" id="passwordInput" placeholder="Enter password" 
                   class="w-full p-4 rounded-lg glass-effect mb-4 focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
            <button onclick="checkPassword()" 
                    class="w-full p-4 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300">
                Access Dashboard
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden max-w-7xl mx-auto p-4 space-y-6">
        <!-- Header with Advanced Controls -->
        <header class="sticky top-0 z-10 glass-effect rounded-2xl p-6 mb-6 animate-slide-up">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                        üî• FusionVIP Dashboard v2.0
                    </h1>
                    <p class="text-gray-300 mt-1">Advanced VIP Management System</p>
                </div>
                <div class="flex gap-3">
                    <div class="relative">
                        <input type="text" id="search" placeholder="üîç Smart Search..." 
                               class="pl-10 pr-4 py-3 rounded-lg glass-effect w-64 focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300">
                        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <button id="autoCleanup" onclick="toggleAutoCleanup()" 
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all duration-300">
                        <span id="cleanupStatus">üîÑ Auto-Clean: OFF</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Enhanced Stats Cards with 3D Effects -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            <!-- Total VIPs Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.1s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Total VIPs</h3>
                            <div class="text-3xl font-bold mt-2" id="totalVips">0</div>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center animate-pulse-glow">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active VIPs Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.2s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Active VIPs</h3>
                            <div class="text-3xl font-bold text-green-400 mt-2" id="activeVips">0</div>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expired VIPs Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.3s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Expired VIPs</h3>
                            <div class="text-3xl font-bold text-red-400 mt-2" id="expiredVips">0</div>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-red-500 to-pink-500 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expiring Soon Card -->
            <div class="gradient-border card-3d animate-fade-in" style="animation-delay: 0.4s">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300">Expiring Soon</h3>
                            <div class="text-3xl font-bold text-yellow-400 mt-2" id="expiringSoon">0</div>
                            <p class="text-sm text-gray-400 mt-1">Next 7 days</p>
                        </div>
                        <div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-500 to-orange-500 flex items-center justify-center">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Add Form -->
        <div class="glass-effect rounded-2xl p-6 animate-slide-up">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <span class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </span>
                Add New VIP User
            </h2>
            <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">HWID</label>
                    <input type="text" placeholder="Enter HWID" id="hwid" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" placeholder="Enter username" id="username" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Expiry Date</label>
                    <input type="date" id="expiry" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Role</label>
                    <input type="text" placeholder="Enter role (e.g., VIP)" id="role" 
                           class="w-full p-3 rounded-lg glass-effect focus:outline-none focus:ring-2 focus:ring-accent-400 transition-all duration-300" value="VIP">
                </div>
                <div class="md:col-span-2 xl:col-span-4">
                    <button type="submit" 
                            class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transform hover:scale-105 transition-all duration-300">
                        ‚ú® Add VIP User
                    </button>
                </div>
            </form>
        </div>

        <!-- Enhanced Data Table with Modern Design -->
        <div class="glass-effect rounded-2xl p-6 animate-slide-up">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                <h2 class="text-2xl font-bold">VIP Users Management</h2>
                <div class="flex gap-3">
                    <button onclick="exportData()" 
                            class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all duration-300">
                        üìä Export
                    </button>
                    <button onclick="cleanupExpired()" 
                            class="px-4 py-2 bg-gradient-to-r from-orange-600 to-red-600 rounded-lg font-semibold hover:from-orange-700 hover:to-red-700 transition-all duration-300">
                        üóëÔ∏è Cleanup Expired
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs uppercase bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                        <tr>
                            <th class="px-6 py-4">
                                <input type="checkbox" id="selectAll" class="rounded">
                            </th>
                            <th class="px-6 py-4 font-semibold">HWID</th>
                            <th class="px-6 py-4 font-semibold">Username</th>
                            <th class="px-6 py-4 font-semibold">Expiry Date</th>
                            <th class="px-6 py-4 font-semibold">Role</th>
                            <th class="px-6 py-4 font-semibold">Status</th>
                            <th class="px-6 py-4 font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="hwidTable" class="divide-y divide-white/10">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="glass-effect rounded-2xl p-6 animate-slide-up">
            <h2 class="text-2xl font-bold mb-6">üìà Analytics Overview</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-lg p-4">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
                <div class="glass-effect rounded-lg p-4">
                    <canvas id="trendsChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Script -->
    <script>
        const PASSWORD = "fusionvip123"; // Your hardcoded password

        function checkPassword() {
            const input = document.getElementById("passwordInput").value;
            if (input === PASSWORD) {
                sessionStorage.setItem("loggedIn", "true");
                document.getElementById("auth").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                initDashboard(); // Initialize dashboard after login
            } else {
                showToast("‚ùå Incorrect password", true);
                document.getElementById("passwordInput").classList.add("shake");
                setTimeout(() => {
                    document.getElementById("passwordInput").classList.remove("shake");
                }, 500);
            }
        }

        // Auto-login if session exists
        if (sessionStorage.getItem("loggedIn")) {
            document.getElementById("auth").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
        }
    </script>

    <!-- Main Enhanced JavaScript with Complete Functionality -->
    <script>
        // Configuration and Variables
        const api = path => `/.netlify/functions/${path}`;
        const tableBody = document.getElementById('hwidTable');
        const form = document.getElementById('addForm');
        const searchInput = document.getElementById('search');
        let hwidList = [];
        let currentDisplayedList = [];
        let inactivityTimer;
        let autoCleanupEnabled = false;
        let cleanupInterval;

        // Initialize Dashboard
        async function initDashboard() {
            await fetchHWIDs();
            initCharts();
            setupEventListeners();
            resetInactivityTimer();
            initDarkMode();
        }

        // Session management with inactivity timer
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                sessionStorage.removeItem('loggedIn');
                showToast("Session expired. Please login again.", true);
                location.reload();
            }, 30 * 60 * 1000); // 30 minutes
        }

        ['mousemove', 'keypress', 'click'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer);
        });

        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const isDark = localStorage.getItem('darkMode') === 'true';
            
            if (isDark) {
                document.documentElement.classList.add('dark');
            }
            
            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
            });
        }

        // Enhanced data fetching with error handling
        async function fetchHWIDs() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                const res = await fetch(api('read-hwid'));
                const data = await res.json();
                hwidList = data.lines || [];
                currentDisplayedList = [...hwidList];
                renderTable(hwidList);
                updateVIPStats();
                updateCharts();
                showToast(`‚úÖ Loaded ${hwidList.length} VIP users`, false);
            } catch (error) {
                console.error('Fetch error:', error);
                showToast("‚ùå Failed to load VIP data", true);
                // Try to load from localStorage as backup
                const cached = localStorage.getItem('hwidList');
                if (cached) {
                    hwidList = JSON.parse(cached);
                    currentDisplayedList = [...hwidList];
                    renderTable(hwidList);
                    updateVIPStats();
                    updateCharts();
                    showToast("üìã Loaded cached data", false);
                }
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Enhanced VIP statistics calculation
        function updateVIPStats() {
            const total = hwidList.length;
            let active = 0;
            let expired = 0;
            let expiringSoon = 0;

            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

            hwidList.forEach(line => {
                const parts = line.split(' ');
                if (parts.length >= 3) {
                    const dateStr = parts[2];
                    if (dateStr && dateStr.includes('-')) {
                        const [dd, mm, yyyy] = dateStr.split('-');
                        if (dd && mm && yyyy) {
                            const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                            
                            if (expiryDate < today) {
                                expired++;
                            } else {
                                active++;
                                if (expiryDate <= nextWeek) {
                                    expiringSoon++;
                                }
                            }
                        }
                    }
                }
            });

            // Save to localStorage
            localStorage.setItem('hwidList', JSON.stringify(hwidList));

            // Animate number updates
            animateNumber('totalVips', total);
            animateNumber('activeVips', active);
            animateNumber('expiredVips', expired);
            animateNumber('expiringSoon', expiringSoon);
        }

        // Number animation function
        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            const step = (targetValue - currentValue) / 20;
            let current = currentValue;
            
            const timer = setInterval(() => {
                current += step;
                if ((step > 0 && current >= targetValue) || (step < 0 && current <= targetValue)) {
                    element.textContent = targetValue;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 50);
        }

        // Enhanced table rendering with search functionality
        function renderTable(dataList) {
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            // Filter data based on search term
            const filteredData = dataList.filter(line => {
                return line.toLowerCase().includes(searchTerm);
            });

            currentDisplayedList = filteredData;

            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-400">
                            ${searchTerm ? 'üîç No results found for your search' : 'üìù No VIP users found'}
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredData.map((line, index) => {
                const parts = line.split(' ');
                const hwid = parts[0] || 'N/A';
                const user = parts[1] || 'N/A';
                const date = parts[2] || 'N/A';
                const role = parts.slice(3).join(' ') || 'VIP';

                // Calculate status
                let statusClass = 'bg-green-500';
                let statusText = 'Active';
                let statusIcon = '‚úÖ';

                if (date && date.includes('-')) {
                    const [dd, mm, yyyy] = date.split('-');
                    if (dd && mm && yyyy) {
                        const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                        const today = new Date();
                        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

                        if (expiryDate < today) {
                            statusClass = 'bg-red-500';
                            statusText = 'Expired';
                            statusIcon = '‚ùå';
                        } else if (expiryDate <= nextWeek) {
                            statusClass = 'bg-yellow-500';
                            statusText = 'Expiring Soon';
                            statusIcon = '‚ö†Ô∏è';
                        }
                    }
                }

                return `
                    <tr class="hover:bg-white/5 transition-all duration-300 border-b border-white/10" data-index="${hwidList.indexOf(line)}">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="row-select rounded" data-hwid="${hwid}">
                        </td>
                        <td class="px-6 py-4 font-mono text-sm" contenteditable="true" data-key="hwid" data-original="${hwid}">${hwid}</td>
                        <td class="px-6 py-4 font-semibold" contenteditable="true" data-key="user" data-original="${user}">${user}</td>
                        <td class="px-6 py-4" contenteditable="true" data-key="date" data-original="${date}">${date}</td>
                        <td class="px-6 py-4" contenteditable="true" data-key="role" data-original="${role}">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-300">
                                ${role}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="status-indicator inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold ${statusClass}/20 text-white">
                                ${statusIcon} ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2">
                                <button onclick="editRow(this)" 
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs transition-colors duration-300">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button onclick="deleteRow('${hwid}')" 
                                        class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-xs transition-colors duration-300">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Add event listeners for inline editing
            setupInlineEditing();
        }

        // Setup inline editing functionality
        function setupInlineEditing() {
            const editableCells = document.querySelectorAll('[contenteditable="true"]');
            
            editableCells.forEach(cell => {
                cell.addEventListener('focus', function() {
                    this.closest('tr').classList.add('editing');
                    if (this.dataset.key === 'role') {
                        // For role cells, edit the text content directly
                        const span = this.querySelector('span');
                        if (span) {
                            this.textContent = span.textContent;
                        }
                    }
                });

                cell.addEventListener('blur', function() {
                    this.closest('tr').classList.remove('editing');
                    if (this.dataset.key === 'role') {
                        // Restore span formatting for role
                        const value = this.textContent.trim();
                        this.innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-300">${value}</span>`;
                    }
                });

                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                        saveInlineEdit(this);
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        // Restore original value
                        if (this.dataset.key === 'role') {
                            const originalValue = this.dataset.original;
                            this.innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-300">${originalValue}</span>`;
                        } else {
                            this.textContent = this.dataset.original;
                        }
                        this.blur();
                    }
                });
            });
        }

        // Save inline edits
        async function saveInlineEdit(cell) {
            const row = cell.closest('tr');
            const originalIndex = parseInt(row.dataset.index);
            const originalLine = hwidList[originalIndex];
            
            if (!originalLine) return;

            const parts = originalLine.split(' ');
            const newValue = cell.dataset.key === 'role' ? 
                cell.querySelector('span')?.textContent || cell.textContent.trim() : 
                cell.textContent.trim();

            // Update the appropriate part
            switch(cell.dataset.key) {
                case 'hwid':
                    parts[0] = newValue;
                    break;
                case 'user':
                    parts[1] = newValue;
                    break;
                case 'date':
                    parts[2] = newValue;
                    break;
                case 'role':
                    parts[3] = newValue;
                    break;
            }

            const newLine = parts.join(' ');
            
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                // Update via API
                const response = await fetch(api('write-hwid'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update',
                        oldData: originalLine,
                        newData: newLine
                    })
                });

                if (response.ok) {
                    // Update local data
                    hwidList[originalIndex] = newLine;
                    cell.dataset.original = newValue;
                    await fetchHWIDs(); // Refresh to ensure consistency
                    showToast('‚úÖ Updated successfully!', false);
                } else {
                    throw new Error('Update failed');
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('‚ùå Update failed', true);
                // Restore original value
                if (cell.dataset.key === 'role') {
                    const originalValue = cell.dataset.original;
                    cell.innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-purple-500/20 text-purple-300">${originalValue}</span>`;
                } else {
                    cell.textContent = cell.dataset.original;
                }
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Edit row function
        function editRow(button) {
            const row = button.closest('tr');
            const editableCells = row.querySelectorAll('[contenteditable="true"]');
            
            if (button.textContent.includes('Edit')) {
                // Enter edit mode
                row.classList.add('editing');
                editableCells[0].focus(); // Focus first editable cell
                button.innerHTML = 'üíæ Save';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                // Save mode
                button.innerHTML = '‚úèÔ∏è Edit';
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                row.classList.remove('editing');
                
                // Save all changes in the row
                editableCells.forEach(cell => {
                    saveInlineEdit(cell);
                });
            }
        }

        // Enhanced delete functionality
        async function deleteRow(hwid) {
            if (!confirm(`Are you sure you want to delete HWID: ${hwid}?`)) return;

            try {
                document.getElementById('loading').classList.remove('hidden');
                
                const response = await fetch(api('write-hwid'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete',
                        hwid: hwid
                    })
                });

                if (response.ok) {
                    await fetchHWIDs(); // Refresh data
                    showToast(`üóëÔ∏è Deleted HWID: ${hwid}`, false);
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('‚ùå Delete failed', true);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Enhanced form submission
        async function handleFormSubmission(e) {
            e.preventDefault();
            
            const hwid = document.getElementById('hwid').value.trim();
            const username = document.getElementById('username').value.trim();
            const expiry = document.getElementById('expiry').value;
            const role = document.getElementById('role').value.trim() || 'VIP';

            // Validation
            if (!hwid || !username || !expiry) {
                showToast('‚ùå Please fill all required fields!', true);
                return;
            }

            // Check for duplicate HWID
            const existingHwid = hwidList.find(line => line.startsWith(hwid + ' '));
            if (existingHwid) {
                showToast('‚ùå HWID already exists!', true);
                return;
            }

            // Convert date format from YYYY-MM-DD to DD-MM-YYYY
            const [yyyy, mm, dd] = expiry.split('-');
            const formattedDate = `${dd}-${mm}-${yyyy}`;
            
            const newEntry = `${hwid} ${username} ${formattedDate} ${role}`;

            try {
                document.getElementById('loading').classList.remove('hidden');
                
                const response = await fetch(api('write-hwid'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'add',
                        data: newEntry
                    })
                });

                if (response.ok) {
                    await fetchHWIDs(); // Refresh data
                    form.reset();
                    showToast('‚úÖ VIP user added successfully!', false);
                } else {
                    throw new Error('Add operation failed');
                }
            } catch (error) {
                console.error('Add error:', error);
                showToast('‚ùå Failed to add VIP user', true);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Form submission
            if (form) {
                form.addEventListener('submit', handleFormSubmission);
            }

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    renderTable(hwidList);
                });
            }

            // Select all functionality
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const rowCheckboxes = document.querySelectorAll('.row-select');
                    rowCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }

            // Set minimum date to today
            const expiryInput = document.getElementById('expiry');
            if (expiryInput) {
                expiryInput.min = new Date().toISOString().split('T')[0];
            }

            // Enter key for password
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
            }
        }

        // Auto cleanup functionality
        function toggleAutoCleanup() {
            autoCleanupEnabled = !autoCleanupEnabled;
            const statusElement = document.getElementById('cleanupStatus');
            const button = document.getElementById('autoCleanup');
            
            if (autoCleanupEnabled) {
                statusElement.textContent = 'üîÑ Auto-Clean: ON';
                button.classList.remove('from-green-600', 'to-emerald-600');
                button.classList.add('from-red-600', 'to-pink-600');
                
                // Start cleanup interval (check every minute)
                cleanupInterval = setInterval(autoCleanExpired, 60000);
                showToast('‚úÖ Auto cleanup enabled!', false);
            } else {
                statusElement.textContent = 'üîÑ Auto-Clean: OFF';
                button.classList.remove('from-red-600', 'to-pink-600');
                button.classList.add('from-green-600', 'to-emerald-600');
                
                clearInterval(cleanupInterval);
                showToast('‚è∏Ô∏è Auto cleanup disabled!', false);
            }
        }

        // Auto cleanup expired entries
        async function autoCleanExpired() {
            const today = new Date();
            const expiredEntries = hwidList.filter(line => {
                const parts = line.split(' ');
                if (parts.length >= 3) {
                    const dateStr = parts[2];
                    if (dateStr && dateStr.includes('-')) {
                        const [dd, mm, yyyy] = dateStr.split('-');
                        const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                        return expiryDate < today;
                    }
                }
                return false;
            });

            if (expiredEntries.length > 0) {
                for (const entry of expiredEntries) {
                    const hwid = entry.split(' ')[0];
                    try {
                        await fetch(api('write-hwid'), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'delete',
                                hwid: hwid
                            })
                        });
                    } catch (error) {
                        console.error('Auto cleanup error:', error);
                    }
                }
                
                await fetchHWIDs();
                showToast(`üóëÔ∏è Auto-deleted ${expiredEntries.length} expired entries`, false);
            }
        }

        // Manual cleanup function
        async function cleanupExpired() {
            if (!confirm('Are you sure you want to delete all expired VIP users?')) return;
            
            const today = new Date();
            const expiredEntries = hwidList.filter(line => {
                const parts = line.split(' ');
                if (parts.length >= 3) {
                    const dateStr = parts[2];
                    if (dateStr && dateStr.includes('-')) {
                        const [dd, mm, yyyy] = dateStr.split('-');
                        const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                        return expiryDate < today;
                    }
                }
                return false;
            });

            if (expiredEntries.length === 0) {
                showToast('‚ÑπÔ∏è No expired entries found', false);
                return;
            }

            try {
                document.getElementById('loading').classList.remove('hidden');
                
                for (const entry of expiredEntries) {
                    const hwid = entry.split(' ')[0];
                    await fetch(api('write-hwid'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'delete',
                            hwid: hwid
                        })
                    });
                }
                
                await fetchHWIDs();
                showToast(`üóëÔ∏è Cleaned up ${expiredEntries.length} expired entries`, false);
            } catch (error) {
                console.error('Cleanup error:', error);
                showToast('‚ùå Cleanup failed', true);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Export data function
        function exportData() {
            if (hwidList.length === 0) {
                showToast('‚ÑπÔ∏è No data to export', false);
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," + 
                "HWID,Username,Expiry Date,Role,Status\n" +
                hwidList.map(line => {
                    const parts = line.split(' ');
                    const hwid = parts[0] || '';
                    const username = parts[1] || '';
                    const date = parts[2] || '';
                    const role = parts.slice(3).join(' ') || 'VIP';
                    
                    let status = 'Active';
                    if (date && date.includes('-')) {
                        const [dd, mm, yyyy] = date.split('-');
                        const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                        if (expiryDate < new Date()) {
                            status = 'Expired';
                        }
                    }
                    
                    return `"${hwid}","${username}","${date}","${role}","${status}"`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `vip_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('üìä Data exported successfully!', false);
        }

        // Enhanced toast notification system
        function showToast(message, isError = false) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast-notification fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold animate-fade-in ${
                isError ? 'bg-red-600' : 'bg-green-600'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Charts initialization
        function initCharts() {
            try {
                // Status distribution chart
                const statusCtx = document.getElementById('statusChart').getContext('2d');
                
                const today = new Date();
                let active = 0, expired = 0;
                
                hwidList.forEach(line => {
                    const parts = line.split(' ');
                    if (parts.length >= 3) {
                        const dateStr = parts[2];
                        if (dateStr && dateStr.includes('-')) {
                            const [dd, mm, yyyy] = dateStr.split('-');
                            const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                            if (expiryDate < today) {
                                expired++;
                            } else {
                                active++;
                            }
                        }
                    }
                });
                
                window.statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Expired'],
                        datasets: [{
                            data: [active, expired],
                            backgroundColor: ['#10B981', '#EF4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'VIP Status Distribution', color: '#fff' },
                            legend: { labels: { color: '#fff' } }
                        }
                    }
                });
                
                // Trends chart (sample data)
                const trendsCtx = document.getElementById('trendsChart').getContext('2d');
                window.trendsChart = new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'New VIPs',
                            data: [12, 19, 15, 25, 22, 18],
                            borderColor: '#8B5CF6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: 'VIP Registration Trends', color: '#fff' },
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Chart initialization error:', error);
            }
        }

        // Update charts when data changes
        function updateCharts() {
            if (window.statusChart) {
                const today = new Date();
                let active = 0, expired = 0;
                
                hwidList.forEach(line => {
                    const parts = line.split(' ');
                    if (parts.length >= 3) {
                        const dateStr = parts[2];
                        if (dateStr && dateStr.includes('-')) {
                            const [dd, mm, yyyy] = dateStr.split('-');
                            const expiryDate = new Date(`${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`);
                            if (expiryDate < today) {
                                expired++;
                            } else {
                                active++;
                            }
                        }
                    }
                });
                
                window.statusChart.data.datasets[0].data = [active, expired];
                window.statusChart.update();
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            
            // Auto-login and initialize if session exists
            if (sessionStorage.getItem("loggedIn")) {
                initDashboard();
            }
        });

        // Initialize if already logged in
        window.onload = async () => {
            if (sessionStorage.getItem("loggedIn")) {
                await initDashboard();
            }
        };
    </script>
</body>
</html>
